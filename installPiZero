AnyfestoBox install on a PiZero
(from the PiFold project on Hackaday https://hackaday.io/project/9498-pifold)
=======================================================================================
Parts List
   Raspberry Pi Zero v1.3 - https://www.adafruit.com/products/2885 - $ 5.00
   Tiny USB OTG Adapter - https://www.adafruit.com/products/2910 - $ 2.95
   16GB or Bigger Micro SD card - Many Sources - $ 5.00 - upward
   Smallest WIFI USB - https://www.adafruit.com/products/814 - $11.95
   LIon Battery 3.7V 2500mAh - https://www.adafruit.com/products/328 - $29.50
   PowerBoost 1000 Charger 5V -https://www.adafruit.com/products/2465 - $19.95
   5V 2.4A 6' MicroUSB Cable - https://www.adafruit.com/products/1995 - $ 7.95 


Hardware Setup
---------------------------------------------------------------------------------------------------------------

    Connect the JST from the Battery to the JST connector on the Powerboost 1000
    If you want to hardwire this to the PiZero
        On the Powerboost solder a red wire to the (+) pad of the USB section and a black wire to the (-) pad
        tbf
    Else
        Get a USB cable that has a microUSB connector at one end
        Snip the other end and strip back the wires
        On the Powerboost solder the red wire to the (+) pad of the USB section and the black wire to the (-) pad
    (Optional) add an on/off switch to EN and GND pads on the Powerboost
    Connect the OTG USB adapter to the OTG UB port on the PiZero
    Connect the USB Wifi dongle to the OTG USB adapter
    Download Raspbian “wheezy” or "jessi" https://www.raspberrypi.org/downloads/raspbian/
    Install Raspberry On SD Card https://www.raspberrypi.org/documentation/installation/installing-images/README.md
    Insert the SD Card into the SD slot on the PiZero

Software Setup
---------------------------------------------------------------------------------------------------------------
There are several options to get into your PiZero

    Boot with a Monitor, Keyboard set up your wifi net connection
    Jessie boots up with SSH enabled so that you can shell in via an ethernet dongle and then set up your wifi net connection.
    If you can/do not have an ethernet dongle or keybaord/monitor the go wi the Headless Install. You can find a detailed step by step walkthough at http://davidmaitland.me/2015/12/raspberry-pi-zero-headless-setup/ This is by far my fave way of initially setting up a Pi to get on my network for further installation.

Login (default user/pssword is pi/raspberry)

If the GUI pops up close out to the CLI

sudo raspi-config
       Enable SSH Server via raspberry-config
       Change Password
       Set Hostname to PiFold
       Set To Boot to the Command Line
       Expand the File System 
       Finish & Reboot

===========================================================================================
Manual Installation
===========================================================================================
=Installing the Basic Packages and Infrastructure
sudo apt-get -y update
sudo apt-get -y upgrade
sudo apt-get -y install locales
sudo locale-gen en_US en_US.UTF-8
sudo apt-get -y install vlc
sudo adduser --no-create-home --shell /bin/false --disabled-password vlc
sudo usermod -G audio,pi vlc
sudo apt-get -y install lighttpd
sudo apt-get -y install dnsmasq
sudo apt-get -y install isc-dhcp-server
sudo apt-get -y install hostapd
sudo apt-get -y install git zip unzip
sudo apt-get -y install perl sox libsox-fmt-all libav-tools
sudo rm /bin/sh
sudo ln /bin/bash /bin/sh
sudo chmod a+rw /bin/sh

= Setup the Directories and lighttpd 
mkdir /home/pi/content
mkdir /home/pi/content/Radio
sudo usermod -d /home/pi/content/Radio vlc
sudo ln -s /home/pi/content /var/www/html/content   
cd /var/www/html
sudo rm index*.html
sudo wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/AnyfestoCHiP-index.html -O index.html
sudo wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/anyfestochiplogosm.jpg -O logo.jpg
cd ~
wget https://github.com/twbs/bootstrap/releases/download/v3.3.7/bootstrap-3.3.7-dist.zip
unzip bootstrap-3.3.7-dist.zip 
sudo cp -r bootstrap-3.3.7-dist/* /var/www/html/
cd /var/www/html/css
sudo wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/carousel.css
cd /var/www/html/js
sudo wget https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js


==Update hostapd

wget http://adafruit-download.s3.amazonaws.com/adafruit_hostapd_14128.zip
zip adafruit_hostapd_14128.zip
sudo mv /usr/sbin/hostapd /usr/sbin/hostapd.old
sudo mv hostapd /usr/sbin
sudo chmod 755 /usr/sbin/hostapd
sudo /etc/init.d/hostapd  stop

=Setup Network and Captive Portal 
cd ~
mkdir configs
cd configs
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/dhcpd.conf 
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/dnsmasq.conf
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/hostapd
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/hostapd.conf
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/interfaces
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/isc-dhcp-server
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/start.sh
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/lighttpd.conf
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/vlchosts
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/hosts
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/hostname
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/rclocal
sudo chown root:root *
sudo chmod a+rx *

sudo mv -f dhcpd.conf /etc/dhcp/dhcpd.conf
sudo mv -f dnsmasq.conf /etc/dnsmasq.conf
sudo mv -f hostapd /etc/default/hostapd
sudo mv -f hostapd.conf /etc/hostapd/hostapd.conf 
sudo mv -f interfaces /etc/network/interfaces 
sudo mv -f isc-dhcp-server /etc/default/isc-dhcp-server
sudo mv -f lighttpd.conf /etc/lighttpd/lighttpd.conf
sudo mv -f vlchosts /usr/share/vlc/lua/http/.hosts
sudo mv -f hosts /etc/hosts
sudo mv -f hostname /etc/hostname
sudo mv -f rclocal /etc/rc.local

=Setup Audio Streaming using VLC
sudo mkdir /etc/vlc 
cd /usr/share/vlc/lua/http/ 
sudo mv .hosts /etc/vlc 
sudo ln -s /etc/vlc/.hosts .hosts
cd /home/chip/content/Radio
wget https://archive.org/download/Old_Radio_Public_Service_Announcements/OldRadio_Pub--Jack_Benny_Tolerance1.mp3  -O welcome.mp3
sudo mv -f ~/configs/start.sh /etc/vlc/start.sh  
sudo chmod a+rx /etc/vlc/start.sh

sudo update-rc.d hostapd enable
sudo update-rc.d isc-dhcp-server enable 

sudo sync 
sudo reboot



 
------------------------------------------------------------------------------------------
Optional - Install Webmin
------------------------------------------------------------------------------------------
sudo nano /etc/apt/sources.list
    Add these two lines at the bottom of the list
      deb http://download.webmin.com/download/repository sarge contrib
      deb http://webmin.mirror.somersettechsolutions.co.uk/repository sarge contrib
    Close and save sources.list
wget http://www.webmin.com/jcameron-key.asc 
sudo apt-key add jcameron-key.asc
sudo apt-get update 
sudo apt-get install webmin

------------------------------------------------------------------------------------------
Optional - Install COPS (Calibre OPDS/HTML PHP Server)
------------------------------------------------------------------------------------------
sudo apt-get install php5-gd php5-sqlite php5-cgi
sudo mkdir /var/www/html/cops
cd /var/www/html/cops
sudo wget https://github.com/seblucas/cops/releases/download/1.0.0RC3/cops-1.0.0RC3.zip
sudo unzip cops-1.0.0RC3.zip
cp config_local.php.example config_local.php  
sudo nano config_local.php
      $config['calibre_directory'] : Path to your Calibre directory.
      $config['cops_use_url_rewriting'] : If you want to enable URL rewriting.
sudo chmod -R  755 *
sudo /etc/lighttpd/lighttpd.conf
      Find
            $HTTP["url"] =~ "^/cgi-bin/" {
  	             cgi.assign = ( ".py" => "/usr/bin/python" )
                } 
      Add below
           $HTTP["url"] =~ "^/" {
  	            cgi.assign = ( ".php" => "/usr/bin/php-cgi" )
                }   
     Then Find
            static-file.exclude-extensions = ( ".php",".pl", ".fcgi" , ".cgi" , ".py" ) 
      Change To
            static-file.exclude-extensions = ( ".pl", ".fcgi" , ".cgi" , ".py" ) 

sudo /etc/php5/cgi-bin/php.ini
     Find
         doc_root = "" 
      Change To 
         doc_root = "/var/www/html/" 

------------------------------------------------------------------------------
Optional - Add IRCd and Web Frontend (Hybrid ircd and KiwiIRC front end https://kiwiirc.com)
------------------------------------------------------------------------------
sudo apt-get -y install ircd-hybrid
cd ~
cd configs
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/ircd.conf
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/ircmotd 
sudo chown root:root *
sudo chmod a+rx *
sudo mv -f ircd.conf /etc/ircd-hybrid/ircd.conf 
sudo mv -f ircdmotd /etc/ircd-hybrid/ircd.motd    

sudo apt-get -y install npm
cd ~
git clone https://github.com/prawnsalad/KiwiIRC.git
cd KiwiIRC
npm install
wget https://raw.githubusercontent.com/tomhiggins/anyfesto/master/deployables/current/kiwiconfig.js
cp kiwiconfig.js config.js  
sudo chmod a+rx config.js
./kiwi build
./kiwi start
# Add a link to http://10.11.99.1:7778 
# Add kiwi start to start on boot
------------------------------------------------------------------------------------------
Optional - Add Mumble Server for secure voip and chat
------------------------------------------------------------------------------------------
sudo apt-get install mumble-server
sudo dpkg-reconfigure mumble-server
   Autostart:  Yes
   High Priority: No
   SuperUser: Set the admin password 
sudo nano /etc/mumble-server.ini
    Find welcomeText and update to whatever you would like displayed when a user joins
    Find serverpassword and update if you would like a password for users, leave as is to  have no password for users.
sudo /etc/init.d/mumble-server restart  
     # Add a link in /opt/piratebox/www/index.html to the service and maybe links to the clients that you can host local

------------------------------------------------------------------------------------------
Optional - Add Kiwix to serve up Wikipedia and other wikimedia sites
------------------------------------------------------------------------------------------
cd ~
wget https://download.kiwix.org/bin/kiwix-server-arm.tar.bz2
bzip2 -d kiwix-server-arm.tar.bz2 
tar xvf kiwix-server-arm.tar
rm kiwix-server-arm.tar
sudo cp kiwix-serve /usr/bin/kiwix-serve
sudo cp kiwix-manage /usr/bin/kiwix-manage
sudo mkdir /home/pi/content/kiwix
     # You can find a list of premade data stores at http://www.kiwix.org/wiki/Content . Use non indexed ones. 
cd /home/pi/content/kiwix
sudo wget http://download.kiwix.org/zim/wikipedia_en_for-schools.zim  # your milage may vary
# If you want to add several zims  wget them to /home/pi/content/kiwix and then use kiwiz-manage to create a libray file
# For each zim add it to the library
sudo kiwix-manage /home/pi/content/kiwix/library.xml /home/pi/content/kiwix/NameOfZimFile.zim 
sudo nano /etc/rc.local                                           # add the line and save
   /usr/bin/kiwix-serve --daemon --port=8099 /home/pi/content/kiwix/wikipedia_en_for-schools.zim
   # If you are using multiple zim files use this line
   /usr/bin/kiwix-serve --daemon --port=8099 --library /home/pi/content/kiwix/library.xml
sudo sync
sudo reboot
# Add a description and link  to http://YourServersIP:8099 to the captive portal landing page so users can get to the main library page

------------------------------------------------------------------------------------------
Optional - PiFM
------------------------------------------------------------------------------------------

git clone https://github.com/rm-hull/pifm cd pifm sudo make mkfifo /tmp/radio
(tie vlc output to /tmp/radio (still banging on the code))
sudo ./pifm /tmp/radio 88.3 44100  (note to self, add this to /etc/vlc/start.sh) ==Reboot
sudo sync 
sudo reboot


====================================================================================================================


